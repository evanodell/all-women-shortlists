---
title: "All Women Short lists Methodology"
editor_options:
  chunk_output_type: console
link-citations: yes
output:
  pdf_document:
    toc: yes
bibliography: women.bib
csl: apa.csl
---

## TO DO:

2. Male MP topic models matching

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```


```{r setup, include = FALSE}
library(reticulate)

use_condaenv(condaenv = "spacy_condaenv", 
             conda = "/Users/evanodell/Documents/anaconda3/bin/conda")

library(drake)
```


# Methodology

Previous research on gender differences in political speech patterns has focused on differences between male and female politicians [@yu2014] or on variations in Hilary Clinton's speech patterns [@jones2016; @bligh2010]. This paper focuses on differences in speech patterns between female Labour MPs nominated through All Women Shortlists (AWS) and female Labour MPs nominated through open short lists. We examined differences in speaking styles using the `Linguistic Inquiry and Word Count 2015` (LIWC) dictionary [@pennebaker2015] and the `spaCy` [@honnibal2017] Parts-of-Speech (POS) tagger. We examined differences in the topics discussed by AWS and non-AWS MPs, using ${\chi}^2$ tests for individual words and for bigrams. We experimented with unsupervised Latent Dirichlet Allocation [@blei2003], and trained a Naive Bayes classifier to distinguish AWS and non-AWS speeches.

To account for the possible effects of age, parliamentary experience and cohort, and in order to compare women selected through all women short lists to women who were not (but who theoretically had the opportunity to contest all-women short lists), our analysis is been restricted only to Labour MPs first elected to the House of Commons in the 1997 General Election, up to but excluding the 2017 General Election. Comparisons between MPs of different parties are also restricted to MPs first elected in the 1997 General Election, and before the 2017 General Election. Speeches made by the Speaker, including Deputy Speakers, were also excluded. Words contained in parentheses were removed, as they are added by Hansard to provide additional information not actually spoken by the MP.[^1] Speeches and data on MPs' gender and party affiliation are from a previously assembled dataset [@odell2018]. Information on candidates selected through all women short lists is from the House of Commons Library [@kelly2016]. Unsuccessful General Election candidates selected through all women short lists who were subsequently elected in a byelection are classified as having been selected on an all women short list. 

Word classification used the `Linguistic Inquiry and Word Count 2015` (LIWC) dictionary [@pennebaker2015] and tokenising tools from the `Quanteda` R package [@benoit2018]. Word counts and words-per-sentence were calculated using `stringi` [@gagolewski2018], a wrapper to the ICU regex library.

Following Yu [-@yu2014] drawing on [@newman2008] we used the following LIWC categories:

* All Pronouns (pronoun)<!-- Feminine: -->
* First person singular pronouns (i) <!-- Feminine: -->
* First person plural pronouns (we)<!-- Masculine: -->
* Verbs (verb)<!-- Feminine: -->
* Auxiliary verbs (auxverb) <!-- Feminine: -->
* Social processes (social) <!-- Feminine: -->
* Positive emotions (posemo) <!-- Feminine: -->
* Negative emotions (negemo) <!-- Feminine: -->
* Tentative words (tentat)<!-- Feminine: -->
* Articles (article) <!-- Masculine: -->
* Prepositions (preps) <!-- Masculine: -->
* Anger words (anger)<!-- Masculine: -->
* Swear words (swear)<!-- Masculine: -->
* Cognitive processes (cogproc)<!-- Masculine: -->
* Words longer than six letters (Sixltr)<!-- Masculine: -->

We also included mean words-per-sentence (WPS), total speach word count (WC) and Flesch–Kincaid grade level (FK) [@kincaid1975], calculated using `Quanteda` [@benoit2018] and `stringi` [@gagolewski2018].

<!--## Corpus creation -->


```{r government-jobs, eval=FALSE, include=FALSE}
library(listviewer)
library(httr)
library(dplyr)

gov <- GET("http://data.parliament.uk/membersdataplatform/services/mnis/Department/0/Government/All/", accept_json())

s <- mnis::tidy_bom(gov)

d <- jsonlite::fromJSON(s)

x <- d$Department$Posts$Post

post_names <- c()

for (i in 1:length( d$Department$Posts$Post$Name)) {
  
  post_names[i] <- d$Department$Posts$Post$Name[[i]]
  
}

for (i in 1:length(post_names)) {
  if (class(x$PostHolders$PostHolder[[i]])=="NULL") { 
    } else {
  
  x$PostHolders$PostHolder[[i]]$post_name <- post_names[i]
  x$PostHolders$PostHolder[[i]]$LayingMinisterName <- as.character(x$PostHolders$PostHolder[[i]]$LayingMinisterName)
    x$PostHolders$PostHolder[[i]]$LayingMinisterName <- NULL
  x$PostHolders$PostHolder[[i]]$Member$CurrentStatus <- NULL
  x$PostHolders$PostHolder[[i]]$Member$DateOfDeath <- NULL
  x$PostHolders$PostHolder[[i]]$Member$HouseEndDate <- NULL
  x$PostHolders$PostHolder[[i]]$HouseEndDate <- NULL
  x$PostHolders$PostHolder[[i]]$Member$Party <- x$PostHolders$PostHolder[[i]]$Member$Party$`#text`

  if (length(x$PostHolders$PostHolder[[i]]$EndDate) > 1) {
    x$PostHolders$PostHolder[[i]]$EndDate <- as.character(x$PostHolders$PostHolder[[i]]$EndDate[1])
  }
  
  
   x$PostHolders$PostHolder[[i]]$Member$LayingMinisterName <- NULL
    x$PostHolders$PostHolder[[i]]$Member$HouseEndDate <- NULL
   
  mem_df <- as.data.frame(x$PostHolders$PostHolder[[i]]$Member)
  
  x$PostHolders$PostHolder[[i]]$Member <- NULL
  
  mem_df <- lapply(mem_df, as.character)

  mem_df$LayingMinisterName <- NULL
  
  mem_df$HouseEndDate <- NULL
  
  x$PostHolders$PostHolder[[i]] <- bind_cols(as.data.frame(x$PostHolders$PostHolder[[i]]), mem_df)
    }
}

government_posts <- bind_rows(x$PostHolders$PostHolder)

names(government_posts) <- snakecase::to_snake_case(names(government_posts))

government_posts$member_id <- if_else(is.na(government_posts$member_id),
                                      government_posts$x_member_id,
                                      government_posts$member_id)

government_posts$type <- "Government"

government_posts$end_date <- if_else(
  government_posts$member_id=="439" & 
    government_posts$post_name=="Secretary of State for Education and Skills", 
  "2006-05-05", government_posts$end_date)

```

```{r opposition-jobs, eval=FALSE, include=FALSE}
library(listviewer)
library(httr)

opp <- GET("http://data.parliament.uk/membersdataplatform/services/mnis/Department/0/Opposition/All/", accept_json())

s <- mnis::tidy_bom(opp)

d <- jsonlite::fromJSON(s)

x <- d$Department$Posts$Post

post_names <- c()

for (i in 1:length( d$Department$Posts$Post$Name)) {
  
  post_names[i] <- d$Department$Posts$Post$Name[[i]]
  
}

for (i in 1:length(post_names)) {
  if (class(x$PostHolders$PostHolder[[i]])=="NULL") { 
    } else {
  
  x$PostHolders$PostHolder[[i]]$post_name <- post_names[i]
  x$PostHolders$PostHolder[[i]]$Member$CurrentStatus <- NULL
  x$PostHolders$PostHolder[[i]]$Member$DateOfDeath <- NULL
  x$PostHolders$PostHolder[[i]]$Member$HouseEndDate <- NULL
  x$PostHolders$PostHolder[[i]]$HouseEndDate <- NULL
  x$PostHolders$PostHolder[[i]]$Member$Party <- x$PostHolders$PostHolder[[i]]$Member$Party$`#text`
# 
   for (j in 1:length(x$PostHolders$PostHolder[[i]]$EndDate[1])) {
     
     if (length(x$PostHolders$PostHolder[[i]]$EndDate[[j]]) > 1) {
       x$PostHolders$PostHolder[[i]]$EndDate[[j]] <- "1"
     }
     
     # x$PostHolders$PostHolder[[i]]$EndDate[[1]] <- x$PostHolders$PostHolder[[i]]$EndDate[[1]][[1]]
   }
  
#  x$PostHolders$PostHolder[[i]]$EndDate <- as.character(x$PostHolders$PostHolder[[i]]$EndDate)
  
   x$PostHolders$PostHolder[[i]]$Member$LayingMinisterName <- NULL
    x$PostHolders$PostHolder[[i]]$Member$HouseEndDate <- NULL

x$PostHolders$PostHolder[[i]]$Member$CurrentStatus <- NULL
   
  mem_df <- as.data.frame(x$PostHolders$PostHolder[[i]]$Member)
  
  x$PostHolders$PostHolder[[i]]$Member <- NULL
  
  mem_df$LayingMinisterName <- NULL
  mem_df$HouseEndDate <- NULL
  
  #mem_df <- lapply(mem_df, as.character)
  
  mem_df$HouseEndDate <- NULL
  mem_df$DateOfBirth <- NULL
  
  x$PostHolders$PostHolder[[i]] <- bind_cols(as.data.frame(x$PostHolders$PostHolder[[i]]), mem_df)
  
  if (!("EndDate..xsi.nil" %in% names(x$PostHolders$PostHolder[[i]]))) {
  
    x$PostHolders$PostHolder[[i]]$EndDate <- as.character(x$PostHolders$PostHolder[[i]]$EndDate)
  }
    }
  

}


non.null.list <- lapply(x$PostHolders$PostHolder, Filter, f = Negate(is.null))

oppo_posts <- bind_rows(non.null.list)

names(oppo_posts) <- snakecase::to_snake_case(names(oppo_posts))

oppo_posts$member_id <- if_else(is.na(oppo_posts$member_id),
                                      oppo_posts$x_member_id,
                                      oppo_posts$member_id)

oppo_posts$type <- "Opposition"

```

```{r lab-fem-jobs, eval=FALSE, include=FALSE}
library(readxl)
library(dplyr)

all_jobs <- bind_rows(oppo_posts, government_posts)

summary(as.factor(all_jobs$gender))

lab_fem_jobs <- all_jobs %>% 
  filter(gender=="F", party %in% c("Labour (Co-op)", "Labour")) %>%
  select(start_date, end_date, member_id, post_name, display_as)

#all_women97_15 <- read_excel("list-of-mps.xlsx")

#lab_fem_jobs$short_list <- lab_fem_jobs$member_id %in% all_women97_15$mnis

lab_fem_jobs$end_date <- if_else(lab_fem_jobs$end_date == "list(`@xsi:nil` = \"true\", `@xmlns:xsi` = \"http://www.w3.org/2001/XMLSchema-instance\")",
                                 "NA", lab_fem_jobs$end_date)

lab_fem_jobs$end_date[lab_fem_jobs$end_date=="NA"] <- NA

lab_fem_jobs$end_date <- as.Date(lab_fem_jobs$end_date)

lab_fem_jobs$start_date <- as.Date(lab_fem_jobs$start_date)

## use interval from lubridate to include jobs

```

```{r Extracing-post-1997-Labour-speeches, eval=FALSE, include=FALSE}
### Extracing post-1997 Labour speeches
library(readr)
library(dplyr)
library(quanteda)
library(readxl)
library(lubridate)
library(stringi)

all_speech <- read_rds("senti_df2.rds")

all_speech$eo_id <- rownames(all_speech)

## Binned into quarters of a year
all_speech$y_since_start <- round(time_length(all_speech$speech_date -
                                          as.Date(all_speech$house_start_date),
                                        unit = "years")* 4)/4

lab_speech <- all_speech %>% 
  filter(party_group == "Labour", as_speaker == FALSE,
         house_start_date >= "1997-05-01", speech_date >= "1997-05-01",
         speech_date < "2017-06-08", word_count > 0)

rm(all_speech)

all_women97_15 <- read_excel("list-of-mps.xlsx")

lab_speech$short_list <- lab_speech$mnis_id %in% all_women97_15$mnis

lab_speech$speech <- stri_replace_all_regex(lab_speech$speech,
                                            c("\\s\\(.*?\\)", "\\s\\[.*?\\]"),
                                            c("", ""), vectorize_all = TRUE)

lab_speech$speech <- stri_replace_all_regex(lab_speech$speech, 
                                            c("^c\\(", "\\)$"),
                                            c("", ""), vectorize_all = TRUE)

library(fuzzyjoin)
test <- fuzzy_left_join(lab_speech, lab_fem_jobs,
                         by = c(
                           "mnis_id" = "member_id",
                           "speech_date" = "start_date",
                           "speech_date" = "end_date"
    ),
  match_fun = list(`==`, `>=`, `<`))

write_rds(lab_speech, "lab_speech.rds")

lab_corpus <- corpus(lab_speech, docid_field = "eo_id", text_field = "speech")

write_rds(lab_corpus, "lab_corpus.rds")
```

<!--### Descriptive Statistics -->

### Descriptive Statistics

```{r lab-desc-stats, eval=FALSE, include=FALSE}
elections <- as.POSIXct(c("1997-05-01", "2001-06-07", "2005-05-05", 
               "2010-05-06", "2015-05-07", "2017-06-07"), tz = "UTC")

labour_intakes <- lab_speech %>% 
  filter(house_start_date %in% elections) %>% 
  group_by(house_start_date, mnis_id) %>% 
  summarise() %>% 
  group_by(house_start_date) %>% 
  summarise(total=n()) 

labour_intakes_women <- lab_speech %>% 
  filter(house_start_date %in% elections, gender=="Female") %>% 
  group_by(house_start_date, mnis_id) %>% 
  summarise() %>% 
  group_by(house_start_date) %>% 
  summarise(women=n()) 

labour_intakes <- labour_intakes %>% left_join(labour_intakes_women)
labour_intakes$perc_women <- (labour_intakes$women/labour_intakes$total)*100

```


```{r lab-desc-stats-table, echo=FALSE, message=FALSE, results='asis'}
library(knitr)
library(kableExtra)
library(dplyr)

labour_intakes_table <- tibble::tribble(
  ~general_election, ~total_mps, ~total_labour_mps, ~total_female_labour_mps, ~newly_elected_mps, ~intake_women, ~intake_short_list, ~nominated_short_list,
  1997L, 659L, 418L, "101 (24%)", 177L, "64 (36%)", 35L, 38L,
  2001L, 659L, 412L, "95 (23%)", 38L, "4 (11%)", 0L, 0L,
  2005L, 646L, 355L, "98 (28%)", 40L, "26 (65%)", 23L, 30L,
  2010L, 650L, 258L, "81 (31%)", 64L, "32 (50%)", 28L, 63L,
  2015L, 650L, 232L, "99 (43%)", 49L, "31 (63%)", 31L, 77L
)

# | General Election | Total MPs | Total Labour MPs | Total Female Labour MPs | Percentage Women MPs | Newly elected MPs | Intake Women | Percentage Intake Women | Intake Short list | Nominated Short list |
# |------------------|-----------|------------------|-------------------------|----------------------|-------------------|--------------|-------------------------|-------------------|----------------------|
# | 1997 | 659 | 418 | 101 | 24.2% | 177 | 64 | 36% | 35 | 38 |
# | 2001 | 659 | 412 | 95 | 23.1% | 38 | 4 | 11% | 0 | 0 |
# | 2005 | 646 | 355 | 98 | 27.6% | 40 | 26 | 65% | 23 | 30 |
# | 2010 | 650 | 258 | 81 | 31.4% | 64 | 32 | 50% | 28 | 63 |
# | 2015 | 650 | 232 | 99 | 42.7% | 49 | 31 | 63% | 31 | 77 |

kable(labour_intakes_table, digits = 2, escape = TRUE, 
      align = c("r","r","r","r","r","r","r","r"),
      caption = "Labour MPs and Intakes",
      col.names = c("General Election",
                    "Total MPs",
                    "Labour MPs",
                    "Female Labour MPs",
                    #"Percentage Women MPs",
                    "Labour MPs Intake",
                    "Intake Women",
                    #"Percentage Intake Women",
                    "Intake Short list",
                    "Nominated Short list")) %>% 
  column_spec(1, width = "1.5cm") %>%
  column_spec(2, width = "1cm") %>%
  column_spec(3, width = "1.5cm") %>%
  column_spec(4:5, width = "2cm") %>%
  column_spec(6:7, width = "1.5cm") %>%
  column_spec(8, width = "2cm") %>%
  kable_styling(latex_options = "striped", full_width = FALSE)

```


Data in this table is from House of Commons library reports [@kelly2016; @audickas2017]. All women short lists were not used by Labour during the 2001 General Election.

```{r speech-stats, eval=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(readxl)

all_speech <- read_rds("senti_df2.rds")

all_women97_15 <- read_excel("list-of-mps.xlsx")

all_speech$short_list <- all_speech$mnis_id %in% all_women97_15$mnis

all_speech <- all_speech %>% 
  filter(as_speaker == FALSE,
         house_start_date >= "1997-05-01", speech_date >= "1997-05-01",
         speech_date < "2017-06-08", word_count > 0)

speech_sum_table1 <- all_speech %>%
  group_by(short_list, gender, party_group) %>%
  summarise(speeches = n(),
            words = sum(word_count)) 

# speech_sum_table1$gender <- case_when(speech_sum_table1$short_list==TRUE ~
#                                        "All Women Shortlists",
#                                      TRUE ~ speech_sum_table1$gender)
# 
# speech_sum_table1$gender <- case_when(speech_sum_table1$short_list==FALSE & 
#                                        speech_sum_table1$party_group=="Labour" & 
#                                        speech_sum_table1$gender=="Female" ~
#                                        "Non-All Women Shortlists",
#                                      TRUE ~ speech_sum_table1$gender )

speech_sum_table2 <- all_speech %>%
  group_by(party_group) %>%
  summarise(speeches = n(),
            words = sum(word_count)) 

speech_sum_table3 <- all_speech %>%
  summarise(speeches = n(),
            words = sum(word_count)) 

speech_sum_table4 <- all_speech %>%
  group_by(gender) %>%
  summarise(speeches = n(),
            words = sum(word_count)) 

speech_sum_table5 <- all_speech %>%
  filter(gender=="Female", party_group=="Labour") %>%
  group_by(party_group, gender) %>%
  summarise(speeches = n(),
            words = sum(word_count))

speech_sum_table <- bind_rows(speech_sum_table1, speech_sum_table2,
                              speech_sum_table3, speech_sum_table4,
                              speech_sum_table5)

speech_sum_table[is.na(speech_sum_table)] <- "All"

# speech_sum_table[10,]$gender <- "All"
# speech_sum_table[10,]$party_group <- "All"
# speech_sum_table[10,]$short_list <- "All"
# speech_sum_table[10,]$speeches <- sum(speech_sum_table$speeches[1:9])
# speech_sum_table[10,]$words <- sum(speech_sum_table$words[1:9])
# 
# speech_sum_table[11,]$gender <- "Female"
# speech_sum_table[11,]$party_group <- "Labour"
# speech_sum_table[11,]$short_list <- "Both"
# speech_sum_table[11,]$speeches <- sum(speech_sum_table$speeches[9], 
#                                       speech_sum_table$speeches[2])
# 
# speech_sum_table[11,]$words <- sum(speech_sum_table$words[9],
#                                    speech_sum_table$words[2])

write_rds(speech_sum_table, "speech_sum_table.rds")
```

```{r speech-stats-table-prep, include=FALSE}
library(readr)
library(knitr)
library(kableExtra)
library(dplyr)

speech_sum_table <- read_rds("speech_sum_table.rds")

speech_sum_table <- speech_sum_table %>% ungroup() %>%
  arrange(party_group, gender, short_list)

speech_sum_table$gender <- case_when(speech_sum_table$short_list==TRUE ~
                                       "All Women Shortlists",
                                     TRUE ~ speech_sum_table$gender)

speech_sum_table$gender <- case_when(speech_sum_table$short_list==FALSE & 
                                       speech_sum_table$party_group=="Labour" & 
                                       speech_sum_table$gender=="Female" ~
                                       "Non-All Women Shortlists",
                                     TRUE ~ speech_sum_table$gender )

speech_sum_table <- speech_sum_table %>% 
  select(-short_list) %>%
  select(party_group, gender, everything())
```

```{r speech-stats-table, echo=FALSE, results = 'asis'}
library(kableExtra)
library(knitr)
kable(speech_sum_table[2:4], digits = 2, 
      caption = "Number of Speeches and Words in Dataset",
      col.names = c("Gender", "Speeches", "Words") )  %>%
  kable_styling(latex_options = "striped")  %>%
  group_rows("Conservatives", 4, 6) %>%
    group_rows("Labour", 7, 11) %>%
  group_rows("Liberal Democrat", 12, 14) %>%
    group_rows("Other", 15, 17) %>%
  add_indent(c(9:10))
```

## Women vs Men

<!--### LIWC creation-->

```{r lab-liwc-creation, eval=FALSE, include=FALSE}
#remotes::install_github("kbenoit/quanteda.dictionaries")
library(quanteda.dictionaries)
library(quanteda)
library(purrr)
library(tidyr)
library(effsize)
library(dplyr)
library(stringi)
library(readr)

lab_speech <- read_rds("lab_speech.rds")

lab_corpus <- read_rds("lab_corpus.rds")

liwc15_dict <- dictionary(file = "dict/LIWC2015_English_Flat.dic",
       format = "LIWC")

lab_liwc <- liwcalike(lab_corpus, 
      dictionary = liwc15_dict, 
      verbose = TRUE) %>%
 left_join(lab_speech, by = c("docname" = "eo_id"))

# lab_liwc$WC <- stri_count_boundaries(lab_liwc$speech,
#                                        type="word", skip_word_none=FALSE)

lab_liwc$WC <- stri_count_boundaries(lab_liwc$speech,
                                         type="word", skip_word_none=FALSE)

lab_liwc$WPS <- lab_liwc$WC/stri_count_boundaries(lab_liwc$speech,
                                                          type="sentence", skip_word_none=FALSE)

lab_liwc[["Sixltr"]] <- sapply(
  tokens(texts(lab_corpus), remove_hyphens = TRUE),
  function(y) sum(stri_length(y) > 6)) / lab_liwc[["WC"]] * 100

# lab_liwc$FK <-  textstat_readability(texts(lab_corpus), "Flesch.Kincaid")
# 
# lab_liwc$FK <- lab_liwc$FK$Flesch.Kincaid
# 
# lab_liwc$FK <- if_else(lab_liwc$WC < 5, NA_real_, lab_liwc$FK)

# lab_liwc$WPS <- lab_liwc$WC/stri_count_boundaries(lab_liwc$speech,
#                                        type="sentence", skip_word_none=FALSE)

lab_liwc$total_syllable <- nsyllable(lab_liwc$speech)

lab_liwc$FK <- case_when(lab_liwc$WC >= 5 ~ 
                            0.39 * lab_liwc$WPS + 
                            11.8 * lab_liwc$total_syllable/
                            lab_liwc$WC - 15.59, TRUE ~ NA_real_)

#lab_liwc$FK2 <- if_else(lab_liwc$WC < 5, NA_real_, lab_liwc$FK2)

lab_liwc <- lab_liwc %>% select(docname, Segment, WC, WPS, FK, everything())

#lab_liwc <- read_rds("lab_liwc.rds")

write_rds(lab_liwc, "lab_liwc.rds")
```



```{r liwc-summaries-women-men, eval=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(purrr)
library(tidyr)

lab_liwc <- read_rds("lab_liwc.rds")

## Group by gender, short_list, see what's up
cols <- names(lab_liwc)[4:92]

lab_liwc_men_women_mean <- list(c("WC"), cols) %>%
 map2(lst(mean=mean, funs(weighted.mean(., WC))),
  ~ lab_liwc %>%
   group_by(gender) %>%
   summarise_at(.x, .y)) %>%
 reduce(inner_join)

#tibble::glimpse(lab_liwc_men_women_mean)

lab_liwc_men_women_tidy_mean <- gather(lab_liwc_men_women_mean, 
          "attribute", "weighted_mean", -gender, -WC) 

lab_liwc_men_women_sd <- list(c("WC"), cols) %>%
 map2(lst(mean=mean, funs(sd(., na.rm=TRUE))),
  ~ lab_liwc %>%
   group_by(gender) %>%
   summarise_at(.x, .y)) %>%
 reduce(inner_join)

lab_liwc_men_women_tidy_sd <- gather(lab_liwc_men_women_sd, "attribute",
                                     "sd", -gender, -WC) 

## Joining together the SD and Means to get CIs

## Calculate Cohen's D in here somehow?
lab_liwc_men_women2 <- left_join(lab_liwc_men_women_tidy_mean, 
         lab_liwc_men_women_tidy_sd) %>% 
 left_join(lab_liwc %>% 
    group_by(gender) %>% summarise(n=n())) %>%
 mutate(se = sd / sqrt(n),
   lower_ci = weighted_mean - qt(1 - (0.05 / 2), n - 1) * se,
   upper_ci = weighted_mean + qt(1 - (0.05 / 2), n - 1) * se)

rm(lab_liwc_men_women_tidy_sd, lab_liwc_men_women_tidy_mean)
```

```{r liwc-tables, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(effsize)

lab_liwc <- read_rds("lab_liwc.rds")

fem_mac <- c("pronoun", "i", "we", "verb", "auxverb", "social", "posemo", 
             "negemo", "tentat", "Sixltr",  "article", "prep",
             "anger", "swear", "cogproc", "WPS", "WC", "FK")

# lab_liwc_men_women2_subset <- lab_liwc_men_women2 %>%
#   filter(attribute %in% fem_mac)

fem_mac_df <- tibble::tibble(
  word_type = fem_mac,
  women = c(1:length(fem_mac)),
  women_sd = c(1:length(fem_mac)),
  men = c(1:length(fem_mac)),
  men_sd = c(1:length(fem_mac)),
  cohen_d = c(1:length(fem_mac)),
  magnitude = c(1:length(fem_mac)))

for (i in fem_mac) {
  d <- (cohen.d(lab_liwc[[i]], lab_liwc$gender, na.rm = TRUE,
                noncentral = FALSE, pooled = TRUE))
  fem_mac_df$women[fem_mac_df$word_type==i] <- mean(lab_liwc[lab_liwc$gender == "Female", i], na.rm = TRUE)
  fem_mac_df$men[fem_mac_df$word_type==i] <- mean(lab_liwc[lab_liwc$gender == "Male", i], na.rm = TRUE)
  fem_mac_df$women_sd[fem_mac_df$word_type==i] <- sd(lab_liwc[lab_liwc$gender == "Female", i], na.rm = TRUE)
  fem_mac_df$men_sd[fem_mac_df$word_type==i] <- sd(lab_liwc[lab_liwc$gender == "Male", i], na.rm = TRUE)
  fem_mac_df$cohen_d[fem_mac_df$word_type==i] <- (d$estimate[[1]])
  fem_mac_df$magnitude[fem_mac_df$word_type==i] <- as.character(d$magnitude[[1]])
}

#fem_mac_df

fem_mac_df$word_type <- recode(fem_mac_df$word_type,
               "pronoun" = "All Pronouns",
               "i" = "First person singular pronouns",
               "verb" = "Verbs",
               "auxverb" = "Auxiliary verbs",
               "social" = "Social processes ",
               "posemo" = "Positive emotions",
               "negemo" = "Negative emotions",
               "tentat" = "Tentative words",
               "Sixltr" = "More than six letters",
               "we" = "First person plural pronouns",
               "article" = "Articles",
               "prep" = "Prepositions",
               "anger" = "Anger words",
               "swear" = "Swear words",
               "cogproc" = "Cognitive processes",
               "WPS" = "Words per Sentence",
               "WC" = "Total Word Count",
               "FK" = "Flesh-Kincaid Grade Level")

```

```{r gender-effect-sizes-table, echo=FALSE, results = 'asis'}
library(knitr)
library(kableExtra)
kable(fem_mac_df, digits = 2, 
      caption = "Effect Sizes for Male and Female Labour MPs",
      col.names = c("", "Mean", "SD", "Mean", "SD",
                    "Cohen's D", "Magnitude") )  %>%
  kable_styling(latex_options = "striped") %>% 
  add_header_above(c(" " = 1, "Women" = 2, "Men" = 2, "Effect Size" = 2))
```

There are no categories where gender differences meet the effect size threshold of $|0.2|$ suggested by Cohen [-@cohen1988, 25--26] to indicate a small effect. 4 categories -- words with more than six letters, prepositions, words-per-sentence and Flesh-Kincaid grade level -- exceeded the $|0.1|$ threshold suggested by Newman et al [-@newman2008].


## Short lists vs Non-Short lists

```{r liwc-short lists, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(effsize)

lab_liwc <- read_rds("lab_liwc.rds")

lab_liwc_women <- filter(lab_liwc, gender=="Female",
                         house_start_date >= "1997-05-01")

## Group by gender, short_lsit, see what's up
cols <- names(lab_liwc_women)[4:92]

lab_liwc_women_mean <- list(c("WC"), cols) %>%
 map2(lst(mean=mean, funs(weighted.mean(., WC, na.rm=TRUE))),
  ~ lab_liwc_women %>%
   group_by(short_list, y_since_start) %>%
   summarise_at(.x, .y)) %>%
 reduce(inner_join)

lab_liwc_women_tidy_mean <- gather(lab_liwc_women_mean, "attribute",
                                   "weighted_mean", -short_list,
                                   -y_since_start) 

lab_liwc_women_sd <- list(c("WC"), cols) %>%
 map2(lst(mean=mean, funs(sd(., na.rm=TRUE))),
  ~ lab_liwc_women %>%
   group_by(gender, short_list, y_since_start) %>%
   summarise_at(.x, .y)) %>%
 reduce(inner_join)

lab_liwc_women_tidy_sd <- gather(lab_liwc_women_sd, "attribute",
                                 "sd", -short_list, -gender,
                                 -y_since_start) 

## Joining together the SD and Means to get CIs
lab_liwc_women2 <- left_join(lab_liwc_women_tidy_mean,
                             lab_liwc_women_tidy_sd) %>% 
 left_join(lab_liwc_women %>% 
    group_by(gender, short_list, y_since_start) %>% summarise(n=n())) %>%
 mutate(se = sd / sqrt(n),
   lower_ci = weighted_mean - qt(1 - (0.05 / 2), n - 1) * se,
   upper_ci = weighted_mean + qt(1 - (0.05 / 2), n - 1) * se)

lab_liwc_women2_subset <- lab_liwc_women2 %>%
  filter(attribute %in% c(fem_mac, "WC"))

```


The following plots show changes in the occurences of selected LIWC terms, words-per-sentence, total word count and Flesch–Kincaid grade level, over the course of an MP's career. There do not appear to be any notable changes in speaking style over the course of female Labour MPs' careers.

```{r short-list-plot-key-variables, eval=FALSE, include=FALSE}
library(ggplot2)

lab_liwc_women2_subset$attribute <- recode(lab_liwc_women2_subset$attribute,
               "pronoun" = "All Pronouns",
               "i" = "First person singular pronouns",
               "verb" = "Verbs",
               "auxverb" = "Auxiliary verbs",
               "social" = "Social processes ",
               "posemo" = "Positive emotions",
               "negemo" = "Negative emotions",
               "tentat" = "Tentative words",
               "Sixltr" = "More than six letters",
               "we" = "First person plural pronouns",
               "article" = "Articles",
               "prep" = "Prepositions",
               "anger" = "Anger words",
               "swear" = "Swear words",
               "cogproc" = "Cognitive processes",
               "WPS" = "Words per Sentence",
               "WC" = "Total Word Count",
               "FK" = "Flesh-Kincaid Grade Level")

lab_liwc_women2_subset$short_list <- recode(
  as.factor(lab_liwc_women2_subset$short_list), 
  "FALSE" = "Open Short List",
  "TRUE" = "All Women Short List")

p_sl1 <- ggplot(data=filter(lab_liwc_women2_subset, 
                            attribute != "Words per Sentence", 
                            attribute != "Total Word Count"),
                aes(x = y_since_start, y = weighted_mean, colour = short_list)) + 
  geom_line(alpha=0.7) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  facet_wrap(~attribute) + 
  labs(title = "Occurence of selected LIWC terms", colour = "") + 
  ylab("Weighted Mean") +
  xlab("Years since entering House of Commons") + 
  theme(legend.position = "bottom")

ggsave("p_sl1.eps", plot = p_sl1, path="plots", device = "eps")

p_sl1

```


```{r sl-wps-plot, eval=FALSE, include=FALSE}
p_sl_wps <- ggplot(data=filter(lab_liwc_women2_subset,
                               attribute=="Words per Sentence"),
                aes(x=y_since_start, y = weighted_mean, colour = short_list)) +
  geom_line(alpha=0.7) +
  labs(title = "Words per Sentence", colour = "") + 
  ylab("Weighted Mean") +
  xlab("Years since entering House of Commons") + 
  theme(legend.position = "bottom")

p_sl_wps
```

```{r sl-wc-plot, eval=FALSE, include=FALSE}
p_sl_wc <- ggplot(data=filter(lab_liwc_women2_subset,
                               attribute=="Total Word Count"),
                aes(x=y_since_start, y = weighted_mean, colour = short_list)) +
  geom_line(alpha=0.7) +
  labs(title = "Total Word Count per Speech", colour = "") + 
  ylab("Mean") +
  xlab("Years since entering House of Commons") + 
  theme(legend.position = "bottom")

p_sl_wc
```



```{r fem-mac-df-sl-creation, include=FALSE}
fem_mac_df_sl <- tibble::tibble(
  word_type = fem_mac,
  short_list = c(1:length(fem_mac)),
  short_list_sd = c(1:length(fem_mac)),
  non_short_list = c(1:length(fem_mac)),
  non_short_list_sd = c(1:length(fem_mac)),
  cohen_d = c(1:length(fem_mac)),
  magnitude = c(1:length(fem_mac)))

lab_liwc_women$short_list <- as.factor(lab_liwc_women$short_list)

for (i in fem_mac) {
  d <- (cohen.d(lab_liwc_women[[i]], lab_liwc_women$short_list, na.rm = TRUE,
                noncentral = FALSE, pooled = TRUE))
  fem_mac_df_sl$short_list[fem_mac_df_sl$word_type==i] <-
    mean(lab_liwc_women[lab_liwc_women$short_list == TRUE, i], na.rm = TRUE)
  fem_mac_df_sl$non_short_list[fem_mac_df_sl$word_type==i] <- 
    mean(lab_liwc_women[lab_liwc_women$short_list == FALSE, i], na.rm = TRUE)
  fem_mac_df_sl$short_list_sd[fem_mac_df_sl$word_type==i]  <- 
      sd(lab_liwc_women[lab_liwc_women$short_list == TRUE, i], na.rm = TRUE)
  fem_mac_df_sl$non_short_list_sd[fem_mac_df_sl$word_type==i] <- 
    sd(lab_liwc_women[lab_liwc_women$short_list == FALSE, i], na.rm = TRUE)
  fem_mac_df_sl$cohen_d[fem_mac_df_sl$word_type == i] <- 
    d$estimate[[1]]
  fem_mac_df_sl$magnitude[fem_mac_df_sl$word_type == i] <-
    as.character(d$magnitude[[1]])
}

fem_mac_df_sl$word_type <- recode(fem_mac_df_sl$word_type,
               "pronoun" = "All Pronouns",
               "i" = "First person singular pronouns",
               "verb" = "Verbs",
               "auxverb" = "Auxiliary verbs",
               "social" = "Social processes ",
               "posemo" = "Positive emotions",
               "negemo" = "Negative emotions",
               "tentat" = "Tentative words",
               "Sixltr" = "More than six letters",
               "we" = "First person plural pronouns",
               "article" = "Articles",
               "prep" = "Prepositions",
               "anger" = "Anger words",
               "swear" = "Swear words",
               "cogproc" = "Cognitive processes",
               "WPS" = "Words per Sentence",
               "WC" = "Total Word Count",
               "FK" = "Flesh-Kincaid Grade Level")

```

```{r sl-effect-sizes, echo=FALSE, results = 'asis'}
library(knitr)
library(kableExtra)
kable(fem_mac_df_sl, digits = 2, 
      caption = "Effect Sizes for Female Labour MPs by selection process",
      col.names = c("", "Mean", "SD", "Mean", "SD",
                    "Cohen's D", "Magnitude")) %>%
  kable_styling(latex_options = "striped") %>% 
  add_header_above(c(" " = 1, "All Women Short lists" = 2,
                     "Open Shorlists" = 2, "Effect Size" = 2))

```


There are no categories among female Labour MPs by selection process meeting the $|0.2|$ threshold. Only one category -- first person plural pronouns, _d_=0.19 -- exceeded $|0.1|$.

## Conservatives vs Labour

```{r tory-labour-extraction, eval=FALSE, include=FALSE}
## same as above, but this time Conservative vs Labour
library(readr)
library(dplyr)
library(quanteda)
library(readxl)
library(lubridate)
library(stringi)

all_speech <- read_rds("senti_df2.rds")

all_speech$eo_id <- rownames(all_speech)

## Binned into quarters of a year
all_speech$y_since_start <- round(time_length(all_speech$speech_date -
                                          as.Date(all_speech$house_start_date),
                                        unit = "years")* 4)/4

con_speech <- filter(all_speech, 
                     party_group == "Conservative", 
                     as_speaker == FALSE, house_start_date >= "1997-05-01", 
                     speech_date >= "1997-05-01", speech_date < "2017-06-08",
                     word_count > 0)

rm(all_speech)

con_speech$speech <- stri_replace_all_regex(con_speech$speech,
                                            c("\\s\\(.*?\\)", "\\s\\[.*?\\]"),
                                            c("", ""), vectorize_all = TRUE)

con_speech$speech <- stri_replace_all_regex(con_speech$speech, 
                                            c("^c\\(", "\\)$"),
                                            c("", ""), vectorize_all = TRUE)


write_rds(con_speech, "con_speech.rds")

con_corpus <- corpus(con_speech, docid_field = "eo_id", text_field = "speech")

write_rds(con_corpus, "con_corpus.rds")
```


```{r tory-labour-liwc, eval=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(effsize)
library(stringi)
library(quanteda)
library(quanteda.dictionaries)

liwc15_dict <- dictionary(file = "dict/LIWC2015_English_Flat.dic",
       format = "LIWC")

con_corpus <- read_rds("con_corpus.rds")

con_speech <- read_rds("con_speech.rds")

con_liwc <- liwcalike(con_corpus, 
      dictionary = liwc15_dict, 
      verbose = TRUE) %>%
  left_join(con_speech, by = c("docname" = "eo_id"))

con_liwc$WC <- stri_count_boundaries(con_liwc$speech,
                                         type="word", skip_word_none=FALSE)

con_liwc$WPS <- con_liwc$WC/stri_count_boundaries(con_liwc$speech,
                                                          type="sentence", skip_word_none=FALSE)

con_liwc[["Sixltr"]] <- sapply(
  tokens(texts(con_corpus), remove_hyphens = TRUE),
  function(y) sum(stri_length(y) > 6)) / con_liwc[["WC"]] * 100

con_liwc$FK <- case_when(con_liwc$WC >= 5 ~ 
                               0.39 * con_liwc$WPS + 
                               11.8 * quanteda::nsyllable(con_liwc$speech)/
                               con_liwc$WC - 15.59, TRUE ~ NA_real_)

#con_liwc$FK2 <- if_else(con_liwc$WC < 5, NA_real_, con_liwc$FK2)

con_liwc <- con_liwc %>% select(docname, Segment, WC, WPS, FK, everything())

#con_liwc <- read_rds("con_liwc.rds")

write_rds(con_liwc, "con_liwc.rds")

```


```{r tory-labour-liwc-analysis, include=FALSE}
library(readr)
library(effsize)
library(dplyr)

con_liwc <- read_rds("con_liwc.rds")

lab_liwc <- read_rds("lab_liwc.rds")

lab_con_liwc <- bind_rows(con_liwc, lab_liwc)

fem_mac <- c("pronoun", "i", "we", "verb", "auxverb", "social", "posemo", 
             "negemo", "tentat", "Sixltr",  "article", "prep",
             "anger", "swear", "cogproc", "WPS", "WC", "FK")

lab_con_df <- tibble::tibble(
  word_type = fem_mac,
  labour = c(1:length(fem_mac)),
  labour_sd = c(1:length(fem_mac)),
  tory = c(1:length(fem_mac)),
  tory_sd = c(1:length(fem_mac)),
  cohen_d = c(1:length(fem_mac)),
  magnitude = c(1:length(fem_mac)))

for (i in fem_mac) {
  d <- (cohen.d(lab_con_liwc[[i]], lab_con_liwc$party_group, na.rm = TRUE,
                noncentral = FALSE, pooled = TRUE))
  lab_con_df$labour[lab_con_df$word_type==i] <- mean(lab_con_liwc[lab_con_liwc$party_group == "Labour", i], na.rm = TRUE)
  lab_con_df$tory[lab_con_df$word_type==i] <- mean(lab_con_liwc[lab_con_liwc$party_group == "Conservative", i], na.rm = TRUE)
  lab_con_df$labour_sd[lab_con_df$word_type==i] <- sd(lab_con_liwc[lab_con_liwc$party_group == "Labour", i], na.rm = TRUE)
  lab_con_df$tory_sd[lab_con_df$word_type==i] <- sd(lab_con_liwc[lab_con_liwc$party_group == "Conservative", i], na.rm = TRUE)
  lab_con_df$cohen_d[lab_con_df$word_type==i] <- (d$estimate[[1]])
  lab_con_df$magnitude[lab_con_df$word_type==i] <- as.character(d$magnitude[[1]])
}

#lab_con_df

lab_con_df$word_type <- recode(lab_con_df$word_type,
                               "pronoun" = "All Pronouns",
                               "i" = "First person singular pronouns",
                               "verb" = "Verbs",
                               "auxverb" = "Auxiliary verbs",
                               "social" = "Social processes ",
                               "posemo" = "Positive emotions",
                               "negemo" = "Negative emotions",
                               "tentat" = "Tentative words",
                               "Sixltr" = "More than six letters",
                               "we" = "First person plural pronouns",
                               "article" = "Articles",
                               "prep" = "Prepositions",
                               "anger" = "Anger words",
                               "swear" = "Swear words",
                               "cogproc" = "Cognitive processes",
                               "WPS" = "Words per Sentence",
                               "WC" = "Total Word Count",
                               "FK" = "Flesh-Kincaid Grade Level")

```


```{r tory-labour-effect-sizes-table, echo=FALSE, results = 'asis'}
library(knitr)
library(kableExtra)
kable(lab_con_df, digits = 2, 
      caption = "Effect Sizes for All Labour and Conservative MPs",
      col.names = c("", "Mean", "SD", "Mean", "SD",
                    "Cohen's D", "Magnitude") )  %>%
  kable_styling(latex_options = "striped") %>% 
  add_header_above(c(" " = 1, "Labour" = 2,
                     "Conservatives" = 2, "Effect Size" = 2))
```

There are no categories with effect sizes exceeding $|0.2|$ between Labour and Conservative MPs, like inter-Labour differences.


## All MPs Gender Differences


```{r other-mp-extraction, eval=FALSE, include=FALSE}
## same as above, but this time Conservative vs Labour
library(readr)
library(dplyr)
library(quanteda)
library(readxl)
library(lubridate)
library(stringi)

all_speech <- read_rds("senti_df2.rds")

all_speech$eo_id <- rownames(all_speech)

## Binned into quarters of a year
all_speech$y_since_start <- round(time_length(all_speech$speech_date -
                                          as.Date(all_speech$house_start_date),
                                        unit = "years")* 4)/4

other_speech <- filter(all_speech, 
                         !(party_group %in% c("Labour", "Conservative")), 
                         house_start_date >= "1997-05-01", as_speaker==FALSE,
                         speech_date >= "1997-05-01", 
                         speech_date < "2017-06-08", word_count > 0)

rm(all_speech)

other_speech$speech <- stri_replace_all_regex(other_speech$speech,
                                              c("\\s\\(.*?\\)", "\\s\\[.*?\\]"),
                                              c("", ""),vectorize_all = TRUE)

other_speech$speech <- stri_replace_all_regex(other_speech$speech, 
                                            c("^c\\(", "\\)$"),
                                            c("", ""), vectorize_all = TRUE)

write_rds(other_speech, "other_speech.rds")

other_corpus <- corpus(other_speech, docid_field = "eo_id", text_field = "speech")

write_rds(other_corpus, "other_corpus.rds")
```


```{r other-mp-liwc, eval=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(effsize)
library(stringi)
library(quanteda)
library(quanteda.dictionaries)

liwc15_dict <- dictionary(file = "dict/LIWC2015_English_Flat.dic",
       format = "LIWC")

other_corpus <- read_rds("other_corpus.rds")

other_speech <- read_rds("other_speech.rds")

other_liwc <- liwcalike(other_corpus, 
      dictionary = liwc15_dict, 
      verbose = TRUE) %>%
  left_join(other_speech, by = c("docname" = "eo_id"))

other_liwc$WC <- stri_count_boundaries(other_liwc$speech,
                                     type="word", skip_word_none=FALSE)

other_liwc[["Sixltr"]] <- sapply(
  tokens(texts(other_corpus), remove_hyphens = TRUE),
  function(y) sum(stri_length(y) > 6)) / other_liwc[["WC"]] * 100



# lab_con_liwc$FK <-  textstat_readability(texts(lab_corpus), "Flesch.Kincaid")
# 
# lab_con_liwc$FK <- lab_con_liwc$FK$Flesch.Kincaid
# 
# lab_con_liwc$FK <- if_else(lab_con_liwc$WC < 5, NA_real_, lab_con_liwc$FK)

other_liwc$WPS <- other_liwc$WC/stri_count_boundaries(other_liwc$speech,
                                                  type="sentence", skip_word_none=FALSE)

other_liwc$FK <- case_when(other_liwc$WC >= 5 ~ 
                           0.39 * other_liwc$WPS + 
                           11.8 * quanteda::nsyllable(other_liwc$speech)/
                           other_liwc$WC - 15.59, TRUE ~ NA_real_)

#lab_con_liwc$FK2 <- if_else(lab_con_liwc$WC < 5, NA_real_, lab_con_liwc$FK2)

other_liwc <- other_liwc %>% select(docname, Segment, WC, WPS, FK, everything())

#lab_con_liwc <- read_rds("lab_con_liwc.rds")

write_rds(other_liwc, "other_liwc.rds")

```



```{r all-parties-gender, eval=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(effsize)

other_liwc <- read_rds("other_liwc.rds")

lab_liwc <- read_rds("lab_liwc.rds")

con_liwc <- read_rds("con_liwc.rds")

all_liwc <- bind_rows(other_liwc, con_liwc, lab_liwc)

fem_mac <- c("pronoun", "i", "we", "verb", "auxverb", "social", "posemo", 
             "negemo", "tentat", "Sixltr",  "article", "prep",
             "anger", "swear", "cogproc", "WPS", "WC", "FK")

all_party_gender_df <- tibble::tibble(
  word_type = fem_mac,
  women = c(1:length(fem_mac)),
  women_sd = c(1:length(fem_mac)),
  men = c(1:length(fem_mac)),
  men_sd = c(1:length(fem_mac)),
  cohen_d = c(1:length(fem_mac)),
  magnitude = c(1:length(fem_mac)))

for (i in fem_mac) {
  d <- (cohen.d(all_liwc[[i]], all_liwc$gender, na.rm = TRUE,
                noncentral = FALSE, pooled = TRUE))
  all_party_gender_df$women[all_party_gender_df$word_type==i] <- mean(all_liwc[all_liwc$gender == "Female", i], na.rm = TRUE)
  all_party_gender_df$men[all_party_gender_df$word_type==i] <- mean(all_liwc[all_liwc$gender == "Male", i], na.rm = TRUE)
  all_party_gender_df$women_sd[all_party_gender_df$word_type==i] <- sd(all_liwc[all_liwc$gender == "Female", i], na.rm = TRUE)
  all_party_gender_df$men_sd[all_party_gender_df$word_type==i] <- sd(all_liwc[all_liwc$gender == "Male", i], na.rm = TRUE)
  all_party_gender_df$cohen_d[all_party_gender_df$word_type==i] <- (d$estimate[[1]])
  all_party_gender_df$magnitude[all_party_gender_df$word_type==i] <- as.character(d$magnitude[[1]])
}

#all_party_gender_df

all_party_gender_df$word_type <- recode(all_party_gender_df$word_type,
                               "pronoun" = "All Pronouns",
                               "i" = "First person singular pronouns",
                               "verb" = "Verbs",
                               "auxverb" = "Auxiliary verbs",
                               "social" = "Social processes ",
                               "posemo" = "Positive emotions",
                               "negemo" = "Negative emotions",
                               "tentat" = "Tentative words",
                               "Sixltr" = "More than six letters",
                               "we" = "First person plural pronouns",
                               "article" = "Articles",
                               "prep" = "Prepositions",
                               "anger" = "Anger words",
                               "swear" = "Swear words",
                               "cogproc" = "Cognitive processes",
                               "WPS" = "Words per Sentence",
                               "WC" = "Total Word Count",
                               "FK" = "Flesh-Kincaid Grade Level")

write_rds(all_party_gender_df, "all_party_gender_df.rds")

```



```{r all-party-effect-sizes, echo=FALSE, results = 'asis'}
library(knitr)
library(kableExtra)
library(readr)
all_party_gender_df <- read_rds("all_party_gender_df.rds")

kable(all_party_gender_df, digits = 2, 
      caption = "Effect Sizes for Male and Female MPs, All Parties",
      col.names = c("", "Mean", "SD", "Mean", "SD",
                    "Cohen's D", "Magnitude")) %>%
  kable_styling(latex_options = "striped") %>% 
  add_header_above(c(" " = 1, "Women" = 2,
                     "Men" = 2, "Effect Size" = 2))

```


## POS Analysis



Part-of-speech (POS) tagging was done using `spaCy` [@honnibal2017] and the `spacyr` package [@benoit2018a]. 

```{r spacy-annotations, eval=FALSE, include=FALSE}
library(spacyr)
library(progress)
library(readr)

lab_speech <- read_rds("lab_speech.rds")

lab_speech$year <- as.factor(lab_speech$year)

split_data <- split(lab_speech, lab_speech$year) ### Splitting data variable

all_names <- names(split_data)

pb_save <- progress_bar$new(total = length(all_names),
                            format = "[:bar] :percent ETA: :eta Elapsed: :elapsedfull")

for (this_name in all_names) {
  save_name <- paste0(this_name, "x.rds")
  write_rds(split_data[[this_name]], path = save_name)
  pb_save$tick()
}


# 
# lab_corpus_sample <- corpus(lab_speech_sample,
#                             docid_field = "eo_id", text_field = "speech")
# 
# system.time(
#   lab_annotate_sample <- spacy_parse(lab_corpus_sample, tag = TRUE,
#                                    dependency = TRUE,  lemma = FALSE,
#                                    pos = FALSE) # need to use lab_corpus for this
# )


#devtools::install_github("quanteda/spacyr")
spacy_install(python_path = "/Users/evanodell/Documents/anaconda3/bin/python3")
spacy_initialize()

atemp <- list.files(pattern = "*x.rds")

pb <- progress_bar$new(total = length(atemp), 
                       format = "[:bar] :percent ETA: :eta Elapsed: :elapsedfull\n")

for (i in atemp) {
   pb$tick(0)
  
  df <- read_rds(i)
  
  message(cat("Corpusising "), i, "\n")
  
  lab_corpus <- corpus(df, docid_field = "eo_id", text_field = "speech")
  
  i <- gsub("x.rds", "", i)
  
  message(cat("Annotating "), i, "\n")
  
  # need to use corpus object for this
  lab_annotate <- spacy_parse(lab_corpus, tag = TRUE, dependency = TRUE,
                            lemma = FALSE, pos = FALSE, entity = TRUE) 
 
  save_name <- paste0("./annotated/ano_", i, ".rds")
  
  write_rds(lab_annotate, path = save_name)
  
  pb$tick()
  
  gc()

}

atemp2 <- list.files("./annotated/", pattern = "*.rds")

atemp2 <- paste0("annotated/", atemp2)

df.list <- sapply(atemp2, read_rds, simplify = FALSE)

annotated_labour <- bind_rows(df.list)

rm(df.list, atemp2)

write_rds(annotated_labour, "annotated_labour.rds")

### Calculate the number of different parts of speech



```

```{r annotations-cleanup, eval=FALSE, include=FALSE}
# !diagnostics off
library(readr)
library(dplyr)
annotated_labour <- read_rds("annotated_labour.rds")

post_df <- tibble::tribble(
     ~tag,    ~POS,
  "-LRB-", "PUNCT",
  "-RRB-", "PUNCT",
      ",", "PUNCT",
      ":", "PUNCT",
      ".", "PUNCT",
     "''", "PUNCT",
   "\"\"", "PUNCT",
     "``", "PUNCT",
      "$",   "SYM",
    "ADD",     "X",
    "AFX",   "ADJ",
    "BES",  "VERB",
     "CC",  "CONJ",
     "CD",   "NUM",
     "DT",   "DET",
     "EX",   "ADV",
     "FW",     "X",
     "GW",     "X",
    "HVS",  "VERB",
   "HYPH", "PUNCT",
     "IN",   "ADP",
     "JJ",   "ADJ",
    "JJR",   "ADJ",
    "JJS",   "ADJ",
     "LS", "PUNCT",
     "MD",  "VERB",
    "NFP", "PUNCT",
    "NIL",    "NA",
     "NN",  "NOUN",
    "NNP", "PROPN",
   "NNPS", "PROPN",
    "NNS",  "NOUN",
    "PDT",   "ADJ",
    "POS",  "PART",
    "PRP",  "PRON",
   "PRP$",   "ADJ",
     "RB",   "ADV",
    "RBR",   "ADV",
    "RBS",   "ADV",
     "RP",  "PART",
    "_SP", "SPACE",
    "SYM",   "SYM",
     "TO",  "PART",
     "UH",  "INTJ",
     "VB",  "VERB",
    "VBD",  "VERB",
    "VBG",  "VERB",
    "VBN",  "VERB",
    "VBP",  "VERB",
    "VBZ",  "VERB",
    "WDT",   "ADJ",
     "WP",  "NOUN",
    "WP$",   "ADJ",
    "WRB",   "ADV",
     "XX",     "X"
  )

post_df$POS <- as.factor(post_df$POS)

annotated_labour <- annotated_labour %>% left_join(post_df)

summary(annotated_labour)

write_rds(annotated_labour, "annotated_labour.rds")

```


```{r tidying-annotations, eval=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(magrittr)
library(tidyr)
library(effsize)

# all_speech <- read_rds("senti_df2.rds")
# 
# speakers <- all_speech %>% filter(party_group == "Labour", as_speaker == TRUE,
#          house_start_date >= "1997-05-01", speech_date >= "1997-05-01",
#          speech_date < "2017-06-08", word_count > 0)
# 
# rm(all_speech)

annotated_labour <- read_rds("annotated_labour.rds")

### remove matches

# ano_lab <- ano_lab %>% filter(!(doc_id %in% speakers$eo_id))

## THere are 129 gender NAs

ano_lab_tag <- annotated_labour %>% 
  filter(POS != "PUNCT", is.na(POS) == FALSE, POS != "SPACE") %>%
  group_by(doc_id, tag) %>%
  summarise(count = n()) %>%
  mutate(freq = count / sum(count)) %>% ungroup() 

ano_lab_tag$count <- NULL

ano_lab_tag <- ano_lab_tag %>% spread(tag, freq)

ano_lab_tag[is.na(ano_lab_tag)] <- 0

ano_lab_pos <- annotated_labour %>% 
  filter(POS != "PUNCT", is.na(POS) == FALSE, POS != "SPACE") %>%
  group_by(doc_id, POS) %>%
  summarise(count = n()) %>%
  mutate(freq = count / sum(count)) %>% ungroup() 

ano_lab_pos$count <- NULL

ano_lab_pos <- ano_lab_pos %>% spread(POS, freq)

ano_lab_pos[is.na(ano_lab_pos)] <- 0

lab_speech <- read_rds("lab_speech.rds")

ano_lab_tag <- ano_lab_tag %>% 
  left_join(select(lab_speech, eo_id, gender, short_list),
            by = c("doc_id"="eo_id"))

ano_lab_pos <- ano_lab_pos %>% 
  left_join(select(lab_speech, eo_id, gender, short_list),
            by = c("doc_id"="eo_id"))

ano_lab_pos$short_list <- as.factor(ano_lab_pos$short_list)
ano_lab_tag$short_list <- as.factor(ano_lab_tag$short_list)

write_rds(ano_lab_pos, "ano_lab_pos.rds")

write_rds(ano_lab_tag, "ano_lab_tag.rds")

```


```{r tag-means, include=FALSE}

library(readr)
library(purrr)
library(dplyr)

ano_lab_tag <- read_rds("ano_lab_tag.rds")

### POS

#word_types_tags <- c("NN", "NNS")

ano_lab_tag_gender <- ano_lab_tag %>% 
  select(NN, NNS, gender) %>% 
  #gather(key = "type", value = "value", NN, NNS) %>%
  group_by(gender)

ano_lab_tag_gender2 <- ano_lab_tag_gender %>% 
  gather(key = "type", value = "value", NN, NNS) %>%
  group_by(gender, type) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))

ano_lab_tag_sl <- ano_lab_tag %>%
  select(NN, NNS, short_list, gender) %>% 
  #gather(key = "type", value = "value", NN, NNS) %>%
  group_by(short_list) %>% filter(gender == "Female") %>% select(-gender)

ano_lab_tag_sl2 <- ano_lab_tag_sl %>% 
  gather(key = "type", value = "value", NN, NNS) %>%
  group_by(short_list, type) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))
```


```{r pos-means, include=FALSE}
library(readr)
library(purrr)
library(dplyr)

ano_lab_pos <- read_rds("ano_lab_pos.rds")

ano_lab_pos_gender <- ano_lab_pos %>% 
  select(NOUN, ADV, VERB, ADJ, gender) %>% 
  group_by(gender)

ano_lab_pos_gender2 <- ano_lab_pos_gender %>% 
  gather(key = "type", value = "value", NOUN, ADV, VERB, ADJ) %>%
  group_by(gender, type) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))

ano_lab_pos_sl <- ano_lab_pos %>%
  select(NOUN, ADV, VERB, ADJ, short_list, gender) %>% 
  group_by(short_list) %>% filter(gender == "Female") %>% select(-gender)

ano_lab_pos_sl2 <- ano_lab_pos_sl %>% 
  gather(key = "type", value = "value", NOUN, ADV, VERB, ADJ) %>%
  group_by(short_list, type) %>%
  summarise(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))

# ano_lab_pos_sl3 <- list(.vars = lst(c("NOUN", "ADV", "VERB", "ADJ")),
#                         .funs = lst(funs(mean = mean, sd = sd,
#                                          .args = c(na.rm = TRUE)))) %>% 
#   pmap(~ ano_lab_pos_sl %>% group_by(short_list) %>% summarise_at(.x, .y)) %>% 
#   reduce(inner_join, by = "short_list")
```

```{r pos-tag-tables, include=FALSE}

pos_df_gender <- bind_rows(ano_lab_pos_gender2, ano_lab_tag_gender2)

pos_df_gender <- pos_df_gender %>% 
  gather(variable, value, -(gender:type)) %>%
  unite(temp, gender, variable) %>%
  spread(temp, value)

pos_df_gender$cohen_d <- NA
pos_df_gender$magnitude <- NA

for (i in pos_df_gender$type) {
  
  if (i=="NN" || i == "NNS") {
  
   d <- (cohen.d(ano_lab_tag[[i]], ano_lab_tag$short_list,
                na.rm = TRUE, noncentral = FALSE, pooled = TRUE))
  } else {
    
     d <- (cohen.d(ano_lab_pos[[i]], ano_lab_pos$short_list,
                na.rm = TRUE, noncentral = FALSE, pooled = TRUE))
  }
   
  pos_df_gender$cohen_d[pos_df_gender$type==i] <- (d$estimate[[1]])
  
  pos_df_gender$magnitude[pos_df_gender$type==i] <- as.character(d$magnitude[[1]])
}

pos_df_gender$type <- factor(pos_df_gender$type, levels=c("NOUN", "NNS", "NN", "ADJ", "ADV", "VERB"))

## Recoding pos_df_sl$type into pos_df_sl$type_rec
pos_df_gender$type <- recode(pos_df_gender$type,
               "NOUN" = "All Nouns",
               "NNS" = "Plural Nouns",
               "NN" = "Singular Nouns",
               "ADJ" = "Adjectives",
               "ADV" = "Adverbs",
               "VERB" = "Verbs")

pos_df_gender <- pos_df_gender[order(pos_df_gender$type),]

pos_df_gender[2:5] <- pos_df_gender[2:5] * 100

pos_df_sl <- bind_rows(ano_lab_pos_sl2, ano_lab_tag_sl2)

pos_df_sl <- pos_df_sl %>% 
  gather(variable, value, -(short_list:type)) %>%
  unite(temp, short_list, variable) %>%
  spread(temp, value)

pos_df_sl$cohen_d <- NA
pos_df_sl$magnitude <- NA

for (i in pos_df_sl$type) {
  
  if (i=="NN" || i == "NNS") {
  
   d <- (cohen.d(ano_lab_tag[[i]], ano_lab_tag$short_list,
                na.rm = TRUE, noncentral = FALSE, pooled = TRUE))
  } else {
    
     d <- (cohen.d(ano_lab_pos[[i]], ano_lab_pos$short_list,
                na.rm = TRUE, noncentral = FALSE, pooled = TRUE))
  }
   
  pos_df_sl$cohen_d[pos_df_sl$type==i] <- (d$estimate[[1]])
  
  pos_df_sl$magnitude[pos_df_sl$type==i] <- as.character(d$magnitude[[1]])
}

pos_df_sl$type <- factor(pos_df_sl$type, levels=c("NOUN", "NNS", "NN", "ADJ", "ADV", "VERB"))

## Recoding pos_df_sl$type into pos_df_sl$type_rec
pos_df_sl$type <- recode(pos_df_sl$type,
               "NOUN" = "All Nouns",
               "NNS" = "Plural Nouns",
               "NN" = "Singular Nouns",
               "ADJ" = "Adjectives",
               "ADV" = "Adverbs",
               "VERB" = "Verbs")

pos_df_sl <- pos_df_sl[order(pos_df_sl$type),]

pos_df_sl[2:5] <- pos_df_sl[2:5] * 100

```


```{r pos-gender-table, echo=FALSE, results = 'asis'}
library(knitr)
library(kableExtra)
kable(pos_df_gender, digits = 2, 
      caption = "Part-of-Speech Effect Sizes for Male and Female Labour MPs",
      col.names = c("Word Type", "Mean", "SD", "Mean", "SD",
                    "Cohen's D", "Magnitude") )  %>%
  kable_styling(latex_options = "striped") %>% 
  add_header_above(c(" " = 1, "Women" = 2, "Men" = 2, "Effect Size" = 2)) %>%
  add_indent(c(2:3))
```


```{r pos-sl-table, echo=FALSE, results = 'asis'}
library(knitr)
library(kableExtra)
kable(pos_df_sl, digits = 2, 
      caption = "Part-of-Speech Effect Sizes for AWS and non-AWS Labour MPs",
      col.names = c("Word Type", "Mean", "SD", "Mean", "SD",
                    "Cohen's D", "Magnitude"))  %>%
  kable_styling(latex_options = "striped") %>% 
  add_header_above(c(" " = 1, "All Women Short lists" = 2,
                     "Open Shorlists" = 2, "Effect Size" = 2)) %>%
  add_indent(c(2:3))
```


## Tokenising / Keyness

The most commonly used words by both men and women would be protocol decorum expressions, so we calculate the keyness of words to identify gender differences in the choices of topics raised by men and women, and by short-list and non-short list women.

### Men vs Women

Keyness -- a linguistic measure of the frequency of different words in two groups of texts -- reveals clear gender differences in the most disproportionately common words used by female and male Labour MPs. Unsurprisingly, despite male MPs saying almost twice as many words (30601887 vs 15898845) <!--Double-check these numbers--> as their female colleagues, female Labour MPs were more than two-and-a-half (2.61) times as likely to say "women". They were also much more likely to refer to "women's" and "woman". Female Labour MPs also appear much more likely to discuss "children", "people", "care", "families", "home", "parents", "work" and social policy areas such as "services", "disabled [people]" and "housing" than their male colleagues. Male MPs were more likely to refer to military topics ("Iraq", "nuclear"), and to parliamentary process and protocol  -- "question", "political", "conservative", "electoral", "house", "party", "argument" "liberal" and "point" are far more common in speeches by male Labour MPs than by female ones. This could suggest that male MPs are more comfortable using the traditional language of House of Commons debate.

```{r dfm-creation, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
library(readr)
library(dplyr)
library(quanteda)

lab_corpus <- read_rds("lab_corpus.rds")

parliament_stopwords <- c(stopwords(), "hon", "rose", "n", "friend", "way", 
                          "give", "gentleman", "right", "percent", "per",
                          "cent", "prime", "minister")

lab_dfm_key <- lab_corpus %>% 
  dfm(remove = parliament_stopwords, remove_punct = TRUE,
      verbose = TRUE, groups = "gender") %>%
  dfm_weight("count")

write_rds(lab_dfm_key, "lab_dfm_key.rds")

lab_corpus_fem <- corpus_subset(lab_corpus, gender=="Female")

lab_dfm_key_fem <- lab_corpus_fem %>% 
  dfm(remove = parliament_stopwords, remove_punct = TRUE,
      verbose = TRUE, groups = "short_list") %>%
  dfm_weight("count")

write_rds(lab_dfm_key_fem, "lab_dfm_key_fem.rds")
```

```{r gender-keyness, echo=FALSE, fig.height=8, message=FALSE, warning=FALSE}
library(ggplot2)
library(readr)
library(dplyr)
library(quanteda)

lab_dfm_key <- read_rds("lab_dfm_key.rds")

lab_keyness <- textstat_keyness(lab_dfm_key, measure = c("chi2"))

#head(lab_keyness)

lab_keyness_plot <- textplot_keyness(lab_keyness, n = 25, 
                                     color = c("purple", "darkgreen")) +  
  #coord_cartesian(xlim=c(-3100, 14100)) +
  scale_x_continuous(limits = c(-3100, 14100), 
                     breaks = seq(-3000, 15000, by = 1500)) + 
  labs(title = "Keyness between Labour MPs, by Gender",
       x = "Chi2") + 
  theme(legend.position = "bottom")

lab_keyness_plot
```



### Short lists vs Non-Short lists


Keyness differences by selection process are not as obviously stereotypical. Nonetheless, the most common words amongst AWS MPs included "carers", "disabled", "bedroom" and "sen"[^2]. Also of note is AWS MPs making more references to their "constituency" and its "constituents", [drawing on representation of ]

```{r short-list-keyness, echo=FALSE, fig.height=8, message=FALSE, warning=FALSE}

lab_dfm_key_fem <- read_rds("lab_dfm_key_fem.rds")

lab_keyness_fem <- textstat_keyness(lab_dfm_key_fem, measure = c("chi2"))

#head(lab_keyness_fem)

fem_keyness_plot <- textplot_keyness(lab_keyness_fem, n=25) + 
  scale_color_manual(labels = c("Non-AWS", "AWS"),
                     values = c("#ff674c", "#02d5a1"), name = NULL) +
  scale_x_continuous(limits = c(-700, 700), 
                     breaks = seq(-500, 800, by = 100)) + 
  labs(title = "Keyness between Female Labour MPs, by Selection Process",
       x = "Chi2") + 
  theme(legend.position = "bottom")

fem_keyness_plot
```


### Labour vs Conservative

The keyness differences between Labour and Conservative MPs are much greater than gender differences within Labour. The very high use of "Lady" by Conservative MPs is reflective of the greater proportion of female MPs in other parties, as it is often used to refer to comments by other members of the house.

```{r eval=FALSE, include=FALSE}
library(readr)
library(quanteda)
library(dplyr)

all_speech <- read_rds("senti_df2.rds")

lab_con_speech <- all_speech %>% 
  filter(party_group %in% c("Labour", "Conservative"),
         as_speaker == FALSE, house_start_date >= "1997-05-01",
         speech_date >= "1997-05-01", speech_date < "2017-06-08",
         word_count > 0)

rm(all_speech)

lab_con_corpus <- corpus(lab_con_speech, 
                         docid_field = "eo_id", text_field = "speech")

parliament_stopwords <- c(stopwords(), "hon", "rose", "n", "friend", "way", 
                          "give", "gentleman", "right", "percent", "per",
                          "cent", "prime", "minister")

lab_con_dfm <- lab_con_corpus %>% 
  dfm(remove = parliament_stopwords, remove_punct = TRUE,
      verbose = TRUE, groups = "party_group") %>%
  dfm_weight("count")

write_rds(lab_con_dfm, "lab_con_dfm.rds")
```


```{r lab-con-keyness, echo=FALSE, fig.height=8, message=FALSE, warning=FALSE}
library(ggplot2)
library(quanteda)

lab_con_dfm <- read_rds("lab_con_dfm.rds")

lab_con_keyness <- textstat_keyness(lab_con_dfm, measure = c("chi2"))

#head(lab_keyness_fem)

lab_con_keyness_plot <- textplot_keyness(lab_con_keyness, n=25, 
                                         color = c("blue", "red")) + 
  scale_x_continuous(limits = c(-4100, 8000), 
                     breaks = seq(-3000, 8000, by = 1000)) +
  labs(title = "Keyness between Labour and Conservative MPs",
       x = "Chi2") + 
  theme(legend.position = "bottom")

lab_con_keyness_plot

```




## Bigrams

We created bigrams of all first person plural and singular pronouns for female Labour MPs.

```{r bigrams-short-list-creation, eval=FALSE, message=FALSE, include=FALSE}
library(quanteda)
library(readr)

lab_corpus <- read_rds("lab_corpus.rds")

lab_corpus_fem <- corpus_subset(lab_corpus, gender=="Female")

fem_bigrams <- tokens(lab_corpus_fem, what = "word", remove_numbers = FALSE,
                       remove_punct = FALSE, remove_symbols = FALSE,  
                       remove_twitter = TRUE, remove_url = TRUE, 
                       ngrams = 2, verbose = TRUE)

bigram_phrases <- c("i", "i'd",  "i'll", "i'm", "i've", "me", "methinks",
                    "mine", "my", "myself", "let's", "lets", "our", "ours",
                    "ourselves", "us", "we", "we'd", "we'll", "we're", "we've")

bigram_phrases <- paste0(bigram_phrases, "_*")

pro_bigram <- tokens_select(fem_bigrams, phrase(bigram_phrases))
#84569

write_rds(pro_bigram, "pro_bigram.rds")
```

```{r bigrams-short-list-keyness, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8}
library(quanteda)
library(readr)
library(ggplot2)

pro_bigram <- read_rds("pro_bigram.rds")

pro_dfm <- dfm(pro_bigram, verbose=TRUE, groups = "short_list") %>%
  dfm_trim(min_termfreq = 100)

pro_dfm_key <- textstat_keyness(pro_dfm, measure = "chi2")

pro_dfm_key$n_total <- pro_dfm_key$n_reference + pro_dfm_key$n_target

pro_dfm_key_plot <- textplot_keyness(pro_dfm_key, n=25) +  
    scale_color_manual(labels = c("Non-AWS", "AWS"), 
                      values = c("#ff674c", "#02d5a1"), name = NULL) +
    scale_x_continuous(limits = c(-650, 500), 
                     breaks = seq(-600, 500, by = 100)) +
  labs(title = "Bigram Keyness in Female Labour MPs by Selection Process",
       x = "Chi2") + 
  theme(legend.position = "bottom")

pro_dfm_key_plot

```

## Naive Bayes classification

We trained a Naive Bayes classifier with document-frequency priors and a multinomial distribution to predict the gender of speakers when given speeches by all Labour MPs in our dataset, and the selection process when only given female Labour MPs. The accuracy of both models were roughly equivalent, 70.55% accuracy when predicting gender and 70.84% when predicting short lists. By contrast, the classifier could distinguish between Labour and Conservative speeches with 74.23% accuracy.

```{r naive-bayes-gender, eval=FALSE, include=FALSE}
library(quanteda)
library(quanteda.corpora)
library(caret)
library(readr)

lab_corpus <- read_rds("lab_corpus.rds")

set.seed(42)
id_train <- sample(1:262071, 104828, replace = FALSE) ## 40% in training
#head(id_train, 10)

docvars(lab_corpus, "id_numeric") <- 1:ndoc(lab_corpus)

# get training set
training_dfm <- corpus_subset(lab_corpus, id_numeric %in% id_train) %>%
  dfm(stem = TRUE)

# get test set (documents not in id_train)
test_dfm <- corpus_subset(lab_corpus, !id_numeric %in% id_train) %>%
  dfm(stem = TRUE)

nb <- textmodel_nb(training_dfm, docvars(training_dfm, "gender"),
                   prior = "docfreq")
#summary(nb)

test_dfm <- dfm_select(test_dfm, training_dfm)

actual_class <- docvars(test_dfm, "gender")
predicted_class <- predict(nb, test_dfm)
class_table <- table(actual_class, predicted_class)
class_table

gender_accuracy <- confusionMatrix(class_table, mode = "everything")
gender_accuracy$overall[[1]]

```

```{r naive-bayes-sl, eval=FALSE, include=FALSE}

### Short List classification
lab_corpus_fem <- corpus_subset(lab_corpus, gender=="Female")

set.seed(42)
id_train <- sample(1:84572, 33829, replace = FALSE) ## 40% in training
head(id_train, 10)

docvars(lab_corpus_fem, "id_numeric") <- 1:ndoc(lab_corpus_fem)

# get training set
training_dfm <- corpus_subset(lab_corpus_fem, id_numeric %in% id_train) %>%
  dfm(stem = TRUE)

# get test set (documents not in id_train)
test_dfm <- corpus_subset(lab_corpus_fem, !id_numeric %in% id_train) %>%
  dfm(stem = TRUE)

nb_fem <- textmodel_nb(training_dfm, docvars(training_dfm, "short_list"),
                   prior = "docfreq")
summary(nb_fem)

test_dfm <- dfm_select(test_dfm, training_dfm)

actual_class <- docvars(test_dfm, "short_list")
predicted_class <- predict(nb_fem, test_dfm)
class_table <- table(actual_class, predicted_class)
class_table

sl_accuracy <- confusionMatrix(class_table, mode = "sens_spec")
sl_accuracy$overall[[1]]
```

```{r naive-bayes-lab-vs-conservative, eval=FALSE, include=FALSE}
library(quanteda)
library(quanteda.corpora)
library(caret)
library(readr)
library(dplyr)

all_speech <- read_rds("senti_df2.rds")

lab_con_speech <- all_speech %>% 
  filter(party_group %in% c("Labour", "Conservative"),
         as_speaker == FALSE, house_start_date >= "1997-05-01",
         speech_date >= "1997-05-01", speech_date < "2017-06-08")

rm(all_speech)

lab_con_corpus <- corpus(lab_con_speech, 
                         docid_field = "eo_id", text_field = "speech")

set.seed(42)
id_train <- sample(1:547233, (547233*0.4), replace = FALSE) ## 40% in training
#head(id_train, 10)

docvars(lab_con_corpus, "id_numeric") <- 1:ndoc(lab_con_corpus)

# get training set
training_dfm <- corpus_subset(lab_con_corpus, id_numeric %in% id_train) %>%
  dfm(stem = TRUE)

# get test set (documents not in id_train)
test_dfm <- corpus_subset(lab_con_corpus, !id_numeric %in% id_train) %>%
  dfm(stem = TRUE)

nb <- textmodel_nb(training_dfm, docvars(training_dfm, "gender"),
                   prior = "docfreq")
#summary(nb)

test_dfm <- dfm_select(test_dfm, training_dfm)

actual_class <- docvars(test_dfm, "gender")
predicted_class <- predict(nb, test_dfm)
class_table <- table(actual_class, predicted_class)
class_table

party_accuracy <- confusionMatrix(class_table, mode = "everything")
party_accuracy$overall[[1]]
round(party_accuracy$overall[[1]], 4)

```

<!--
```{r svm, eval=FALSE, include=FALSE}
library(readr)
library(quanteda)
library(tidyr)
library(e1071) ## look up name of this SVM library
library(dplyr)

parliament_stopwords <- c(stopwords(), "hon", "rose", "n", "friend", "way", 
                          "give", "gentleman", "right", "percent", "per",
                          "cent", "prime", "minister")

lab_corpus <- read_rds("lab_corpus.rds")

lab_corpus2 <- corpus_sample(lab_corpus, size = ndoc(lab_corpus)/500, replace = TRUE)

lab_dfm2 <- lab_corpus2 %>% 
  dfm(remove = parliament_stopwords, remove_punct = TRUE,
      verbose = TRUE) 

lab_df <- as.matrix(lab_dfm2)

lab_df <- as.data.frame(lab_df, row.names = docnames(lab_dfm2))

# x2 <- convert(lab_dfm2, to = "tripletlist")
# 
# x <- slam::as.simple_triplet_matrix(lab_dfm2)
# 
# models <- svm(x=x2$vocab, y=x2$meta$gender)

lab_df$eo_id <- row.names(lab_df)

lab_docvars <- docvars(lab_corpus2)

lab_docvars$eo_id <- row.names(lab_docvars)

lab_docvars <- select(lab_docvars, gender, eo_id) %>% rename(mp_gender=gender)

lab_df <- left_join(lab_df, lab_docvars)

lab_df$mp_gender <- as.factor(lab_df$mp_gender)

row.names(lab_df) <- lab_df$eo_id

lab_df <- lab_df %>% select(mp_gender, everything(), -eo_id)

# #x <- x[,2:3402]
# 
# x2 <- as.data.frame(t(x))
# 
# x2 <- x2[,2:3402]
# 
# x3 <- gather(x2, key = "gender", value = "count")
# # 
# # x2 <- as.data.frame(t(x))
# # 
# # 

x <- colSums(lab_df[,!names(lab_df)=="mp_gender"])

summary(x)

index <- 1:nrow(lab_df)
   testindex <- sample(index, trunc(length(index)/3))
   testset   <- lab_df[testindex,]
   trainset  <- lab_df[-testindex,]

   
# library(sampling)
# strata_training <- strata(trainset, stratanames = "emptyvar", size = c(1000,500))
# #this creates a sample of size 1000 and 500 for 0 and 1 each
# strata.train<-getdata(train,Training)
# #it creates additional 3 columns which you can remove
# train<-strata.train[,!colnames(strata.train) %in% c("ID_unit","Prob","Stratum")]
#    
## Need to make sure that all columns have at least some values other than 0

model <- svm(mp_gender~., data = trainset) ## This is failing, find out why
pred  <- predict(model, testset[,-10])   



## need to get svm(x,y) working, with vector of document classes

lab_dfm_fem <- read_rds("lab_dfm_key_fem.rds")

vm.model <- svm(docs ~ ., data = x, cost = 100, gamma = 1)

 data(Glass, package="mlbench")
 ## split data into a train and test set
   index     <- 1:nrow(Glass)
   testindex <- sample(index, trunc(length(index)/3))
   testset   <- Glass[testindex,]
   trainset  <- Glass[-testindex,]

```
-->


## Topic Models

Using topic models to classify text is widely used in social sciences, as, when combined with the large volume of plain text data available, it allows for a rapid and consistent method of analysis. Topic modelling and other statistic methods of textual analysis are not a substitute for reading the texts themselves, but can augment other analysis or -- as in this case -- analyse and classify larger amounts of text than would be feasible using human coders [@grimmer2013]. Topic models classify a series of documents (in this case individual speeches) into one of a given number of topics, identifying terms that are common in some documents but rare in others. When developing topic models, there is a trade-off between high precision in the classification of each document with broader topics when using smaller numbers of topics, or lower precision in individual speech classification with more finely-grained topics when using larger numbers of topics. Grimmer and Stewart also highlight the importance of validating unsurpervised topic models when applied to new sets of texts. 


The R package `stm` [@roberts2018] implements a structured topic model (STM) [@roberts2016; @arora2013]. An STM incorporates data about the writer or speaker into the topic classification algorithm. We incorporated the AWS status of speakers into our topic model. We used an algorith developed by Lee and Mimno [-@lee2014c], implemented in the `stm` package [@roberts2018], to estimate the number of topics across all speeches made by female Labour MPs. The resulting topic model has 69 topics, across 81,607 documents and a dictionary of 115,477 words.

<!--
 <!--We then used `stm`'s implementation of Latent Dirichlet Allocation [@blei2003]-->



### Short lists vs Non-Short lists
<!--
```{r STM-Ksearch, eval=FALSE, include=FALSE}
library(stm)
library(quanteda)
library(quanteda.corpora)
library(topicmodels)
library(readr)

lab_corpus <- read_rds("lab_corpus.rds")

lab_corpus_fem <- corpus_subset(lab_corpus, gender=="Female")

parliament_stopwords <- c(stopwords(), "hon", "rose", "n", "friend", "way", 
                          "give", "gentleman", "right", "percent", "per",
                          "cent", "prime", "minister", "c")
rm(lab_corpus)
#ndoc(lab_corpus_fem)

lab_corpus_fem_dfm <- dfm(lab_corpus_fem, remove_punct = TRUE,
                           remove = parliament_stopwords, verbose = TRUE) #%>% 
#  dfm_trim(min_termfreq = 0.95, termfreq_type = "quantile", 
#           max_docfreq = 0.1, docfreq_type = "prop")


lab_corpus_fem_stm <- convert(lab_corpus_fem_dfm, to = "stm", docvars = NULL)

lab_corpus_fem_stm$meta$short_list <- as.factor(lab_corpus_fem_stm$meta$short_list)

topic_numbers <-c(10, 20, 50)

kresult <- searchK(lab_corpus_fem_stm$documents, 
                   vocab = lab_corpus_fem_stm$vocab, K = topic_numbers,
                   prevalence=~short_list, data=lab_corpus_fem_stm$meta,
                   verbose = TRUE)
#plot(kresult)

```
-->

```{r STM-classification-prep, eval=FALSE, include=FALSE}
library(stm)
library(quanteda)
library(quanteda.corpora)
library(topicmodels)
library(readr)

lab_corpus <- read_rds("lab_corpus.rds")

lab_corpus_fem <- corpus_subset(lab_corpus, gender=="Female")

parliament_stopwords <- c(stopwords(), "hon", "rose", "n", "friend", "way", 
                          "give", "gentleman", "right", "percent", "per",
                          "cent", "prime", "minister", "c")
rm(lab_corpus)
#ndoc(lab_corpus_fem)

lab_corpus_fem_stm <- dfm(lab_corpus_fem, remove_punct = TRUE,
                           remove = parliament_stopwords, verbose = TRUE) %>%
  convert(to = "stm", docvars = NULL)

lab_corpus_fem_stm$meta$short_list <- as.factor(lab_corpus_fem_stm$meta$short_list)

write_rds(lab_corpus_fem_stm, "lab_corpus_fem_stm.rds")
```

```{r STM-classification, eval=FALSE, include=FALSE}
library(stm)
library(quanteda)
library(quanteda.corpora)
library(topicmodels)
library(readr)
set.seed(402)

topic_model2 <- stm(lab_corpus_fem_stm$documents, 
                    vocab = lab_corpus_fem_stm$vocab, 
                    K = 0, prevalence = ~short_list, 
                    data = lab_corpus_fem_stm$meta,
                    verbose = TRUE, init.type = "Spectral")

write_rds(topic_model2, "stm-topic-model2.rds")

```

```{r stm-analysis, echo=FALSE}
library(readr)
library(stm)

topic_model2 <- read_rds("stm-topic-model2.rds")

lab_corpus_fem_stm <- read_rds("lab_corpus_fem_stm.rds")

#plot(topic_model2)

corr_topic <- topicCorr(topic_model2, method = "huge")

prep <- estimateEffect(1:69 ~ short_list, topic_model2, 
                       meta = lab_corpus_fem_stm$meta, uncertainty = "Global")

#summary(prep)

prep_df <- summary(prep)[[3]]

prep_df <- as.data.frame(do.call(rbind, prep_df))

prep_df$topic <- rep(1:69, each = 2)

prep_df$type <- row.names(prep_df)

prep_df$type <- gsub("\\.[0-9][0-9]", "", prep_df$type)

prep_df$type <- gsub("\\.[0-9]", "", prep_df$type)

prep_df$type <- gsub("\\.$", "", prep_df$type)

prep_df_coeff <- prep_df %>% filter(type == "short_listTRUE")

### Figure out distribution of topics amongst short_list, non-short lists
## assign colour schemes
## If I can get the differences for each topic number, I can great a pallette
# I can presumably also create a size parameter, make common topics bigger
# Need to get that data out of prep_df

library(igraph)
p_topic1 <- plot(corr_topic, vlabels = c(1:69),
                 vertex.color = viridis::cividis(10))

# plot(topic_model2, type = "summary")
# 
# gg <- nexus.get("Davis")
# plot(gg)
# 
# library(GGally)
# 
# test_plot <- ggnet2(corr_topic)

#x <- labelTopics(topic_model2)

```

## Discussion

There do not appear to be substantial or meaningful differences in the speaking styles or topic choices of female Labour MPs selected through all women short lists when compared to their female colleagues selected through open short lists. The few small differences between male and female Labour MPs were not replicated when comparing female Labour MPs by how they were selected.

There is more gender distinction in selected terms and topics.


# References

[^1]: e.g. a reference to "the member for Bethnal Green and Bow" in keeping with Parliamentary convention of identifying MPs by their seat rather than their name would be followed by "(Rushnara Ali)".

[^2]: Special Educational Needs